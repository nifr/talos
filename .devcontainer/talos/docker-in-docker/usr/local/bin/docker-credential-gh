#!/usr/bin/env -S bash --noprofile --norc -o errexit -o pipefail -o noclobber -o nounset

## as long as "gh" does not provide a "gh configure-docker" subcommand or acts itself as credential helper we use this
## see: https://github.com/cli/cli/issues/5150
## see: https://gist.github.com/mislav/e154d707db230dc882d7194ec85d79f6
## alternative: https://github.com/bradschwartz/docker-credential-ghcr-login
##
## usage:  echo 'ghcr.io' | docker-credential-gh get
## output: {"Username":"nifr", "Secret":"github_pat_xxxxxx"}

if [ -z "$(command -v gh 2>&1 >/dev/null)" ]; then
  echo "gh cli not installed" >&2
  exit 1
fi

if ! gh auth status 2>&1 >/dev/null; then
  echo "gh cli not authenticated" >&2
  exit 1
fi

cmd="$1"
if [ "erase" = "$cmd" ]; then
  cat - >/dev/null
  exit 0
fi
if [ "store" = "$cmd" ]; then
  cat - >/dev/null
  exit 0
fi
if [ "get" != "$cmd" ]; then
  exit 1
fi

host="$(cat -)"
host="${host#https://}"
host="${host%/}"
if [ "$host" != "ghcr.io" ] && [ "$host" != "docker.pkg.github.com" ]; then
  exit 1
fi

token="$(gh config get -h github.com oauth_token)"
if [ -z "$token" ]; then
  exit 1
fi

printf '{"Username":"%s", "Secret":"%s"}\n' "$(gh api user -q '.login')" "$token"
