#!/usr/bin/env -S bash -euo pipefail

## see: https://github.com/siderolabs/talos/releases
readonly TALOS_IMAGE_VERSION='v1.11.1'
readonly TALOS_IMAGE_ARCH='arm64' # You can change to arm architecture

# HCloud server architecture can be x86 or arm
readonly HCLOUD_SERVER_ARCH=$(case "${TALOS_IMAGE_ARCH}" in 'amd64') echo 'x86' ;; 'arm64') echo 'arm' ;; esac)

readonly downloadUrl="https://factory.talos.dev/image/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba/${TALOS_IMAGE_VERSION}/hcloud-${TALOS_IMAGE_ARCH}.raw.xz"

if [ ! command -v 'hcloud-upload-image' &> /dev/null ]; then
  echo "hcloud-upload-image could not be found, please install it first."
  exit 1
fi

: "${HCLOUD_TOKEN:?HCLOUD_TOKEN environment variable is not set. Please set it to your Hetzner Cloud API token.}"

printf '=== Test if download URL "%s" is valid\n' \
  "${downloadUrl}"
curl \
  --silent \
  --location \
  --head \
  --fail \
  --fail-early \
  --show-error \
  --output '/dev/null' \
    "${downloadUrl}"

readonly tempFolder="$(mktemp -d)"
readonly tempFile="${tempFolder}/talos-image-$(date +%Y%m%d%H%M%S).raw.xz"

printf '=== Download talos image from URL "%s" \n' \
  "${downloadUrl}"
curl \
  --silent \
  --location \
  --output "${tempFile}" \
    "${downloadUrl}"

printf '=== upload talos image "%s" to Hetzner Cloud \n' \
  "${tempFile}"
hcloud-upload-image upload \
      --verbose='2' \
      --architecture="${HCLOUD_SERVER_ARCH}" \
      --description="Talos ${TALOS_IMAGE_VERSION} ${TALOS_IMAGE_ARCH} uploaded on $(date +%Y-%m-%d)" \
      --compression='xz' \
      --labels "os=talos,version=${TALOS_IMAGE_VERSION}" \
      --image-path="${tempFile}"
      # --image-url "${downloadUrl}"

echo "=== Talos image upload completed."

## output:
## > Successfully uploaded the image! image=316900484

printf '=== Clean up temporary folder "%s"\n' \
  "${tempFolder}"
rm -rf "${tempFolder}"
